{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="{% static 'style/home.css' %}">
	<link rel="stylesheet" href="{% static 'style/profile.css' %}">
	<link rel="icon" type="image/png" href="{% static 'img/Log/NovaVerse.svg' %}" sizes="32x32">
	<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
	<title>NovaVerse</title>
</head>

<body>

	{% include 'nav.html' %}

	<!-- ================ main ================ -->
	<main>
		<div class="container">
			<!-- ================ left ================ -->
			<div class="left">
				{% include 'sidebar.html' %}
			</div>
			<!-- ================ End of left ================ -->

			<!-- ================ middle ================ -->
			<div class="middle">
				<!-- ================ profile ================ -->
				<div class="profile">
					<div class="profile-photo">
						<a href="{% url 'profile' profile.user.username %}">
							{% if profile.picture %}
							<img src="{{ profile.picture.url }}" alt="">
							{% else %}
							<img src="{% static 'img/default.jpg' %}" alt="Default Profile Picture">
							{% endif %}
						</a>
					</div>
					<div class="user-info">
						<div>
							<h1>{{profile.first_name}} {{profile.last_name}}</h1>
							<h5 class="text-muted">@{{profile.user.username}}</h5>
							<h6> {{profile.bio}}</h6>
						</div>
						<div>

							{% if request.user == profile.user %}
							<a href="{% url 'edit-profile' %}" class="btn btn-primary">Edit Profile</a>
							{% else %}
							{% if not follow_status %}
							<a href="{% url 'follow' profile.user.username 1 %}" class="btn btn-primary">Follow</a>
							{% else %}
							<a href="{% url 'follow' profile.user.username 0 %}" class="btn btn-primary">Unfollow</a>
							{% endif %}
							<a href="{% url 'new-message' profile.user.username %}" class="btn btn-primary">Message</a>
							{% endif %}

						</div>
						<div class="account-stats">
							<div>
								<h4>
									{% if not post_count %}
									0
									{% else %}
									{{post_count}}
									{% endif %}
								</h4>
								<h5>Posts</h5>
							</div>
							<div>
								<h4>
									{% if not followers_count %}
									0
									{% else %}
									{{followers_count}}
									{% endif %}
								</h4>
								<h5>Followers</h5>
							</div>
							<div>
								<h4>
									{% if not following_count %}
									0
									{% else %}
									{{following_count}}
									{% endif %}
								</h4>
								<h5>Following</h5>
							</div>
						</div>
					</div>
				</div>
				<!-- ================ end of profile ================ -->

				<!-- ================ user Posts ================ -->
				<div class="feeds">

					{% for post in posts %}
					<!-- ================ post one================ -->
					<div class="feed">
						<div class="head">
							<div class="user">
								<div class="profile-photo">
									<a href="{% url 'profile' profile.user.username %}">
										{% if profile.picture %}
										<img src="{{ profile.picture.url }}" alt="">
										{% else %}
										<img src="{% static 'img/default.jpg' %}" alt="Default Profile Picture">
										{% endif %}
									</a>
								</div>
								<div class="info">
									<h3>{{ post.user.username }}</h3>
									<small>{{ post.posted }}</small>
								</div>
							</div>
							<span class="edit">
								<i class='bx bx-dots-horizontal-rounded'></i>
							</span>
						</div>
						<div class="photo">
							<a href="{% url 'post-detail' post.id %}"><img src="{{ post.picture.url }}"></a>
						</div>

						<div class="action-buttons">
							<div class="interaction-buttons">
								<span>
									<a href="{% url 'like' post.id %}" class="like-button" data-id="{{ post.id }}">
										<i id="like-icon-{{ post.id }}"
											class='bx bxs-heart {% if post.liked %} liked {% endif %}'></i>
									</a>
								</span>
								<span><i class='bx bxs-comment-detail'></i></span>
								<span><i class='bx bxs-share-alt'></i></span>
							</div>
							<div class="bookmark">
								<span>
									<a href="{% url 'favourite' post.id %}" class="favourite-button"
										data-id="{{post.id}}">
										<i class='bx bxs-bookmark {% if post.is_favourite %} liked {% endif %}'></i>
									</a>
								</span>
							</div>
						</div>
						<div class="liked-by">
							<span><img src="{% static 'img/profile-10.jpg' %}"></span>
							<span><img src="{% static 'img/profile-11.jpg' %}"></span>
							<span><img src="{% static 'img/profile-12.jpg' %}"></span>
							<p><b id="like-count-{{ post.id }}"> {{ post.likes }}
								</b> likes</p>
						</div>
						<div class="caption">
							<p>
								{{post.caption}}

								{% for tag in post.tags.all %}
								<a href="{{tag.get_absolute_url}}"><span class="harsh-tag">
										#{{tag.title}}</span></a>
								{% endfor %}
							</p>
						</div>
						<div class="comment text-muted">
							view all comments
						</div>
					</div>
					<!-- ================ end of post one ================ -->
					{% endfor %}

				</div>
			</div>
			<!-- ================ middle ================ -->
		</div>
	</main>


	{% include 'themes.html' %}
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="{% static 'js/home.js' %}"></script>
	<script>
		$(document).ready(function () {
			$('.like-button').click(function (e) {
				e.preventDefault();
				var post_id = $(this).data('id');
				var csrf_token = '{{ csrf_token }}';
				var like_url = $(this).attr('href');

				$.ajax({
					type: 'POST',
					url: like_url,
					data: {
						'csrfmiddlewaretoken': csrf_token,
					},
					success: function (response) {
						console.log('Success:', response); // Debugging
						$('#like-count-' + post_id).text(response.likes);
						if (response.liked) {
							$('#like-icon-' + post_id).addClass('liked');
						} else {
							$('#like-icon-' + post_id).removeClass('liked');
						}
					},
					error: function (response) {
						console.log('Error:', response); // Debugging
					}
				});
			});
		});
	</script>
	<script>
		$(document).ready(function () {
			$('.favourite-button').click(function (e) {
				e.preventDefault();
				var button = $(this);
				var post_id = button.data('id');
				var url = button.attr('href');

				$.ajax({
					type: 'POST',
					url: url,
					data: {
						'csrfmiddlewaretoken': '{{ csrf_token }}',
					},
					success: function (response) {
						if (response.is_favourite) {
							button.find('i').addClass('liked');
						} else {
							button.find('i').removeClass('liked');
						}
					},
					error: function (response) {
						console.error('Error:', response);
					}
				});
			});
		});
	</script>

</body>

</html>